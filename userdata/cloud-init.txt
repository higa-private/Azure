#cloud-config
runcmd:
  # SELinuxを一時的に無効化し、設定ファイルを修正
  - setenforce 0
  - sed -i 's/SELINUX=enforcing/SELINUX=disabled/' /etc/selinux/config

  # IPv6を一時的に無効化
  - sysctl -w net.ipv6.conf.all.disable_ipv6=1
  - sysctl -w net.ipv6.conf.default.disable_ipv6=1
  
  # 設定ファイルを編集
  - echo "net.ipv6.conf.all.disable_ipv6 = 1" >> /etc/sysctl.conf
  - echo "net.ipv6.conf.default.disable_ipv6 = 1" >> /etc/sysctl.conf
  
  # 設定を反映
  - sysctl -p
  
   Azure CLIをインストール
  - rpm --import https://packages.microsoft.com/keys/microsoft.asc
  - dnf install -y https://packages.microsoft.com/config/rhel/9.0/packages-microsoft-prod.rpm
  - dnf install -y azure-cli

   Dockerをインストール
  - dnf config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
  - dnf install -y docker-ce docker-ce-cli containerd.io

   GitHub Actions Runner セットアップを実行
  - systemctl enable --now docker

  # ワンライナーで書かないとエラーになる
  - sudo -u azureuser bash -c "
      mkdir -p ~/actions-runner/_work && cd ~/actions-runner && curl -o actions-runner.tar.gz -L https://github.com/actions/runner/releases/download/v2.328.0/actions-runner-linux-x64-2.328.0.tar.gz && tar xzf actions-runner.tar.gz && rm actions-runner.tar.gz && ./config.sh --url https://github.com/higa-private/Azure --token BXBOUNGSRKPL3AMI5P6SGILIZGCBW --unattended --replace
    "
  - sudo -u azureuser bash -c "
    cd ~/actions-runner && sudo ./svc.sh install && sudo ./svc.sh start
    "